<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§¸ LITTLE NOOK POS - ç©©å®šä¿®å¾©ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --main-brown: #b0a496; --bg-cream: #fcf8f5; --accent-brown: #8c7b6c; --price-red: #d9534f; --profit-green: #6b8e23; }
        body { font-family: sans-serif; background: var(--bg-cream); margin: 0; display: flex; flex-direction: column; height: 100vh; color: #5d5246; overflow: hidden; }
        header { background: var(--main-brown); color: white; padding: 12px; text-align: center; font-size: 1.3em; font-weight: bold; flex-shrink: 0; }
        .nav-bar { background: #e8e0d9; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 2px solid #d1c7bc; flex-shrink: 0; }
        .nav-btn { background: white; border: 1px solid #d1c7bc; padding: 8px 18px; border-radius: 20px; white-space: nowrap; cursor: pointer; }
        .main-content { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }
        .item-area { flex: 1.8; overflow-y: auto; background: white; border-radius: 15px; padding: 15px; border: 2px solid #e8e0d9; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .p-btn { background: white; border: 1px solid #f0e6dd; border-radius: 12px; padding: 10px; text-align: center; cursor: pointer; box-shadow: 2px 2px 0 #e8e0d9; }
        .checkout-area { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 320px; }
        .card { background: white; border-radius: 15px; padding: 12px; border: 2px solid #e8e0d9; }
        .big-input { font-size: 1.5em; width: 100%; border-radius: 8px; border: 1px solid #ddd; text-align: right; box-sizing: border-box; }
        .total-display { font-size: 2.5em; font-weight: bold; color: var(--price-red); text-align: right; margin: 10px 0; }
        #admin-panel, #history-panel { position: fixed; inset: 10px; background: white; z-index: 1000; border-radius: 20px; display: none; flex-direction: column; padding: 20px; border: 3px solid var(--main-brown); box-shadow: 0 0 50px rgba(0,0,0,0.3); }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<header>ğŸ§¸ LITTLE NOOK POS ç®¡ç†ç³»çµ±</header>
<div class="nav-bar" id="navbar"></div>

<div class="main-content">
    <div class="item-area" id="item-area">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div class="checkout-area">
        <div class="card">
            <strong>ğŸ›’ çµå¸³æ¸…å–®</strong>
            <div id="cart-list" style="min-height:100px; max-height:200px; overflow-y:auto; border-bottom:1px dashed #ccc; margin:10px 0;"></div>
            <input type="number" id="discount" class="big-input" placeholder="æŠ˜æ‰£é‡‘é¡" oninput="calc()">
            <div class="total-display">$<span id="final-total">0</span></div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button onclick="setPay('ç¾é‡‘')" id="btn-cash" style="flex:1; padding:10px;">ğŸ’µ ç¾é‡‘</button>
                <button onclick="setPay('é›»æ”¯')" id="btn-elec" style="flex:1; padding:10px;">ğŸ“± é›»æ”¯</button>
            </div>
            <input type="number" id="cash-in" class="big-input" placeholder="å¯¦æ”¶" oninput="calc()">
            <div style="text-align:right;">æ‰¾é›¶: <span id="cash-change" style="font-weight:bold; color:red;">0</span></div>
            <button onclick="submitOrder()" style="width:100%; padding:15px; background:var(--profit-green); color:white; border:none; border-radius:10px; font-weight:bold; margin-top:10px; cursor:pointer;">å®Œæˆäº¤æ˜“</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="togglePanel('admin-panel')" style="flex:1; padding:10px;">ğŸ› ï¸ ç®¡ç†</button>
            <button onclick="togglePanel('history-panel')" style="flex:1; padding:10px;">ğŸ“œ æ­·å²</button>
        </div>
    </div>
</div>

<div id="admin-panel">
    <div style="display:flex; justify-content:space-between;"><h2>ç®¡ç†ä¸­å¿ƒ</h2><button onclick="togglePanel('admin-panel')">âœ•</button></div>
    <button onclick="exportToExcel()" style="background:#217346; color:white; padding:8px;">åŒ¯å‡º Excel</button>
    <div id="admin-content"></div>
</div>

<div id="history-panel">
    <div style="display:flex; justify-content:space-between;"><h2>æ­·å²ç´€éŒ„</h2><button onclick="togglePanel('history-panel')">âœ•</button></div>
    <div id="history-content"></div>
</div>

<script>
    // âš ï¸ è«‹ç¢ºä¿é€™æ®µé…ç½®èˆ‡ä½ æœ‹å‹çµ¦çš„ä¸€æ¨¡ä¸€æ¨£
    const firebaseConfig = {
        apiKey: "AIzaSyA-cxLaa0z17gjPYYmXJBFHhlvnHZMn0Wk",
        authDomain: "allove-75af5.firebaseapp.com",
        databaseURL: "https://allove-75af5-default-rtdb.firebaseio.com/",
        projectId: "allove-75af5",
        storageBucket: "allove-75af5.firebasestorage.app",
        messagingSenderId: "1046256611808",
        appId: "1:1046256611808:web:8b7ede065e065a72c5fb85"
    };

    // åˆå§‹åŒ– Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—", e); }

    let inv = []; let orders = []; let cart = []; let currentPay = 'ç¾é‡‘';

    // å•Ÿå‹•å‡½æ•¸
    function start() {
        if (!db) { document.getElementById('item-area').innerText = "è³‡æ–™åº«é€£ç·šå¤±æ•—"; return; }
        
        // ç›£è½å•†å“
        db.ref('inventory').on('value', snap => {
            inv = snap.val() || [];
            renderUI();
        }, err => { document.getElementById('item-area').innerText = "è®€å–æ¬Šé™ä¸è¶³: " + err.message; });

        // ç›£è½è¨‚å–®
        db.ref('orders').on('value', snap => {
            const data = snap.val();
            orders = data ? Object.values(data) : [];
        });
    }

    function renderUI() {
        const area = document.getElementById('item-area');
        const nav = document.getElementById('navbar');
        area.innerHTML = ''; nav.innerHTML = '';

        if (inv.length === 0) { area.innerHTML = "ç›®å‰æ²’æœ‰å•†å“ï¼Œè«‹è‡³ç®¡ç†ä¸­å¿ƒæ–°å¢ã€‚"; return; }

        inv.forEach((cat, ci) => {
            nav.innerHTML += `<button class="nav-btn" onclick="document.getElementById('c${ci}').scrollIntoView()">${cat.cat}</button>`;
            let html = `<div id="c${ci}" style="font-weight:bold; margin:15px 0 5px;">${cat.cat}</div><div class="product-grid">`;
            (cat.items || []).forEach((it, ii) => {
                html += `<div class="p-btn" onclick="addToCart(${ci}, ${ii})">
                    <div style="font-size:0.9em; font-weight:bold;">${it.n}</div>
                    <div style="color:var(--accent-brown)">$${it.p}</div>
                    <div style="font-size:0.7em; color:#999;">å­˜:${it.s}</div>
                </div>`;
            });
            area.innerHTML += html + '</div>';
        });
    }

    function addToCart(ci, ii) {
        cart.push({...inv[ci].items[ii], ci, ii});
        renderCart();
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        list.innerHTML = cart.map((it, i) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${it.n}</span><span>$${it.p} <b onclick="removeFromCart(${i})" style="color:red; cursor:pointer;">âœ•</b></span></div>`).join('');
        calc();
    }

    function removeFromCart(i) { cart.splice(i,1); renderCart(); }

    function calc() {
        const total = cart.reduce((a,b)=>a+b.p, 0) - Number(document.getElementById('discount').value || 0);
        document.getElementById('final-total').innerText = Math.max(0, total);
        const cash = Number(document.getElementById('cash-in').value || 0);
        document.getElementById('cash-change').innerText = cash > total ? cash - total : 0;
    }

    function setPay(m) {
        currentPay = m;
        document.getElementById('btn-cash').style.background = m==='ç¾é‡‘'?'#8c7b6c':'#fff';
        document.getElementById('btn-elec').style.background = m==='é›»æ”¯'?'#8c7b6c':'#fff';
    }

    function submitOrder() {
        if(!cart.length) return alert("è«‹å…ˆé¸æ“‡å•†å“");
        const total = Number(document.getElementById('final-total').innerText);
        
        const newOrder = {
            d: new Date().toLocaleDateString(),
            t: new Date().toLocaleTimeString(),
            total: total,
            pay: currentPay,
            items: cart.map(i => i.n).join(',')
        };

        // æ›´æ–°æœ¬åœ°åº«å­˜ä¸¦ä¸Šå‚³
        cart.forEach(c => { if(inv[c.ci].items[c.ii].s > 0) inv[c.ci].items[c.ii].s--; });
        
        db.ref('orders').push(newOrder);
        db.ref('inventory').set(inv);
        
        alert("çµå¸³å®Œæˆï¼");
        cart = []; renderCart();
        document.getElementById('discount').value = '';
        document.getElementById('cash-in').value = '';
    }

    function togglePanel(id) {
        const p = document.getElementById(id);
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }

    function exportToExcel() {
        const ws = XLSX.utils.json_to_sheet(orders);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, "LittleNook_Sales.xlsx");
    }

    // åŸ·è¡Œ
    start();
</script>
</body>
</html>
